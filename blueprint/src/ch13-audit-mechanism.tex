% AMATELUS Audit Mechanism Specification
% Based on version 1.1 dated 2025-10-14
% Foundation: Anonymous Hash Identifier White Paper (Version 2)

\chapter{Audit Mechanism: Anonymous Hash Identifier (AHI)}


\begin{definition}
  \label{def:aud-chapter}
  This chapter covers audit mechanism: anonymous hash identifier (ahi) aspects of AMATELUS.
  \uses{def:amatelus,def:crypto-assumptions}
  \lean{AMATELUS.Audit}
  \leanok
\end{definition}
\section{Overview}

This chapter specifies the \textbf{optional audit mechanism} within AMATELUS protocol.
The \textbf{Anonymous Hash Identifier (AHI)} is used \textbf{only when required by Issuer or Verifier},
protecting citizen privacy while enabling audits based on legal procedures and accountability.

\subsection{Key Premise: AHI is Optional}

AHI is used only in the following cases:

\begin{enumerate}
  \item \textbf{Services requiring audit}:
    \begin{itemize}
      \item Tax and benefit services
      \item Licensing and permits
      \item Financial institution compliance
    \end{itemize}

  \item \textbf{Anti-Sybil services}:
    \begin{itemize}
      \item Social networks (misinformation prevention)
      \item Ticket sales (scalping prevention)
      \item Online gaming (multi-accounting prevention)
    \end{itemize}

  \item \textbf{Services explicitly requiring AHI}
\end{enumerate}

When AHI is not required, standard VC and ZKP mechanisms provide complete privacy.

\subsection{Problem Statement}

Traditional audit DIDs had critical vulnerabilities:

\begin{itemize}
  \item \textbf{Intentional key loss}: Citizens could discard secret keys to evade tracking
  \item \textbf{Cross-service linkage}: Single audit DID creates profiling risks across services
  \item \textbf{Privacy-security tradeoff}: Difficult to balance audit capability with privacy
\end{itemize}

AHI resolves these through cryptographic binding to national identity numbers.

\subsection{Design Goals}

\begin{itemize}
  \item \textbf{Optionality}: AHI is protocol-optional, not mandatory
  \item \textbf{Privacy}: Prevent government centralization of citizen information
  \item \textbf{Anti-linkage}: Prevent profiling across different services
  \item \textbf{Audit guarantee}: Make evasion technically impossible for audit-required services
  \item \textbf{Legal alignment}: Enable audits based on court warrants and legal procedure
  \item \textbf{Global applicability}: Work with or without national ID systems
\end{itemize}

\section{Architecture}

\subsection{Actors and Roles}

\begin{table}[h]
\centering
\begin{tabular}{|l|l|l|}
\hline
\textbf{Actor} & \textbf{Role} & \textbf{Responsibility} \\
\hline
Citizen & Service user & Generate and manage AHI, create ZKP \\
Municipality & VC issuer & Execute court-ordered national ID disclosure \\
Government/Audit Authority & Audit administrator & Issue and publish audit section IDs \\
Service Provider & Service operator & Verify ZKP, record AHI, detect fraud \\
Court & Legal authority & Warrant issuance and legitimacy review \\
Investigating Agency & Investigation authority & Request disclosure and investigate \\
\hline
\end{tabular}
\end{table}

\subsection{System Architecture}

The audit mechanism involves three key components:

\begin{enumerate}
  \item \textbf{Audit Section Identifier}: Public identifier issued by government for each audit purpose
  \item \textbf{Anonymous Hash Identifier}: Hash computed as $H(\text{AuditSectionID} \parallel \text{NationalID})$
  \item \textbf{Zero-Knowledge Proof}: Proves hash generation correctness without revealing NationalID
\end{enumerate}

Critical: These components are used \textbf{only when AHI is required}.

\subsection{National ID System Abstraction}

AMATELUS does not depend on specific national ID schemes. Compatible systems include:

\begin{itemize}
  \item My Number (Japan)
  \item Social Security Number (USA)
  \item National Insurance Number (UK)
  \item Other national identification schemes
\end{itemize}

For countries without national ID systems, AHI functionality is unavailable, but other AMATELUS features
(VC, ZKP, DID) work normally.

\section{Data Structures}

\subsection{Audit Section Identifier}

\begin{verbatim}
structure AuditCategoryId where
  id : String
  purpose : String              -- e.g., "taxation", "benefits", "licensing"
  issuer : ValidDID             -- Government or audit authority DID
  issuedAt : Nat                -- Issuance timestamp
  deriving Repr, DecidableEq
\end{verbatim}

Properties:
\begin{itemize}
  \item Issued by government for each audit purpose
  \item Verifiable in public registry
  \item Guaranteed unique (UUID or random string)
  \item Example: \texttt{"tax-2025"}, \texttt{"subsidy-education-2025"}, \texttt{"permit-building-tokyo"}
\end{itemize}

\subsection{Anonymous Hash Identifier}

\begin{verbatim}
def generateAnonymousHashId
    (categoryId : AuditCategoryId)
    (myNumber : String) : ByteArray :=
  -- Post-quantum cryptography resistant hash function
  Hash.pqcHash (categoryId.id ++ "||" ++ myNumber)
\end{verbatim}

Mathematical definition:
\[
\text{AHI} = H(\text{AuditCategoryID} \parallel \text{NationalID})
\]

where $H$ is a PQC-resistant hash function.

Properties:
\begin{itemize}
  \item Uses post-quantum cryptography (SHA-3, BLAKE3, etc.)
  \item Service-specific identifiers (prevents cross-service linking)
  \item One-way function (irreversible)
  \item Collision-resistant
\end{itemize}

\subsection{National ID Verifiable Credential}

\textbf{Important}: This VC is required only when using AHI. Services not requiring AHI do not need it.

\begin{verbatim}
{
  "@context": ["https://www.w3.org/2018/credentials/v1"],
  "type": ["VerifiableCredential", "HouseholdCredential"],
  "issuer": "did:amatelus:city-hall-tokyo",
  "issuanceDate": "2025-10-14T00:00:00Z",
  "credentialSubject": {
    "id": "did:amatelus:citizen123...",
    "myNumber": "encrypted_my_number",
    "name": "Taro Tanaka",
    "address": "Tokyo, Shinjuku...",
    "birthDate": "1990-01-01"
  },
  "proof": {
    "type": "Dilithium2Signature2025",
    "verificationMethod": "did:amatelus:city-hall-tokyo#key-1",
    "proofValue": "..."
  }
}
\end{verbatim}

Critical design:
\begin{itemize}
  \item National ID is encrypted in VC's data field
  \item Wallet decrypts only for AHI generation (when required)
  \item Services not requesting AHI never see the encrypted data
\end{itemize}

\subsection{Zero-Knowledge Proof for AHI}

\begin{verbatim}
structure AnonymousHashZKP where
  -- Public inputs
  publicInputs : {
    anonymousHashId : ByteArray        -- AHI
    categoryId : AuditCategoryId       -- Audit section ID
    vcIssuer : ValidDID                -- Household VC issuer DID
  }
  -- Secret inputs (used only within ZKP)
  witness : {
    myNumber : String                  -- National ID
    householdVC : HouseholdVC          -- Household VC
    vcSignature : Signature            -- VC signature
  }
  -- ZKP proof data
  proof : ZKProof
  deriving Repr
\end{verbatim}

Proof contents verified within ZKP circuit:
\begin{enumerate}
  \item \texttt{householdVC.proof} is valid (issued by municipality)
  \item \texttt{myNumber} matches \texttt{householdVC.credentialSubject.myNumber}
  \item \texttt{anonymousHashId = Hash(categoryId.id || myNumber)} computation is correct
  \item \texttt{vcIssuer} matches \texttt{householdVC.issuer}
\end{enumerate}

\section{Audit Flows}

\subsection{Standard Flow: Without AHI (Privacy-Preserving Mode)}

\textbf{Most services use this flow. AHI is not required.}

\begin{enumerate}
  \item Citizen presents attribute proofs via ZKP (no personal information)
  \item Service verifies ZKP
  \item Service provides service
\end{enumerate}

Sequence:
\begin{verbatim}
Citizen Wallet              Service Provider
    |                            |
    |--- ZKP (attribute) ------->|
    |                            |
    |                      ZKP verification
    |                            |
    |<------ Service provided ----|
\end{verbatim}

In this flow:
\begin{itemize}
  \item National ID is never used
  \item No hash identifiers created
  \item Complete privacy is maintained
\end{itemize}

\subsection{Audit-Required Flow: With AHI}

\textbf{Only services explicitly requiring AHI use this flow.}

Preconditions:
\begin{itemize}
  \item Service provider explicitly requires AHI
  \item Citizen resides in country with national ID system
  \item Citizen possesses national ID VC
\end{itemize}

Flow:
\begin{enumerate}
  \item Citizen presents ZKP (attribute proof), AHI, and ZKP(AHI validity)
  \item Service verifies ZKP and AHI validity
  \item Service records AHI (not national ID)
  \item Service provides service
\end{enumerate}

Sequence:
\begin{verbatim}
Citizen Wallet              Service Provider
    |                            |
    |--- ZKP + AHI + ZKP(AHI) ->|
    |                            |
    |                      ZKP verification
    |                      AHI validation
    |                      AHI recording
    |                            |
    |<------ Service provided ----|
\end{verbatim}

Critical property: \textbf{National ID remains non-disclosed (secret input within ZKP)}.

\subsection{Audit Section ID Generation and Publication}

This step is performed only for audit-required services.

\begin{enumerate}
  \item Government/audit authority defines audit purpose
  \item Generates unique audit section ID
  \item Publishes to public registry
  \item Service providers requesting AHI obtain the ID
  \item Service notifies citizens that AHI is required
\end{enumerate}

Examples:
\begin{itemize}
  \item Government services: \texttt{"tax-2025"}, \texttt{"subsidy-education-2025"}
  \item Private services: \texttt{"sns-service-x"}, \texttt{"ticket-sales-y"}
\end{itemize}

\subsection{AHI Generation Flow}

\begin{enumerate}
  \item \textbf{Wallet obtains national ID} from household VC
  \item \textbf{Wallet obtains audit section ID} from government registry
  \item \textbf{Wallet computes}: $\text{AHI} = H(\text{AuditCategoryID} \parallel \text{NationalID})$
  \item \textbf{Wallet generates ZKP} proving valid hash without revealing national ID
  \item \textbf{Wallet presents} AHI and ZKP to service provider
  \item \textbf{Service verifies} ZKP and records AHI
\end{enumerate}

Sequence diagram:
\begin{verbatim}
Citizen Wallet      Government Registry    Service Provider
    |                    |                      |
    |--- Request ID ---->|                      |
    |<------ ID ---------|                      |
    |                    |                      |
    |--- Compute AHI -----|                      |
    |--- Generate ZKP ----|                      |
    |                    |                      |
    |--- AHI + ZKP --------------------------->|
    |                    |                      |
    |                    |                  ZKP verification
    |                    |                  AHI recording
    |                    |                      |
    |<------------ Service provided ----------|
\end{verbatim}

\subsection{Fraud Investigation and Audit Flow}

\begin{enumerate}
  \item \textbf{Fraud detection}: Service provider detects suspicious activity
  \item \textbf{Report}: Service identifies corresponding AHI
  \item \textbf{Legal request}: Investigating agency requests disclosure
  \item \textbf{Court review}: Court verifies legitimacy and issues warrant
  \item \textbf{Reverse lookup}: Municipality matches AHI to national ID
  \item \textbf{Disclosure}: Municipality reveals national ID to agency
  \item \textbf{Investigation}: Agency identifies and investigates individual
\end{enumerate}

Reverse lookup algorithm:
\begin{verbatim}
For each nationalID in municipality_database:
  if Hash(auditSectionID || nationalID) == suspicious_AHI:
    return nationalID  // Individual identified
\end{verbatim}

Sequence diagram:
\begin{verbatim}
Service    Agency    Court    Municipality
    |        |        |            |
    |--fraud report->|            |
    | (AHI)         |            |
    |        |--disclosure------>|
    |        |   request         |
    |        |        |          |
    |        |        |---warrant|
    |        |        |          |
    |        |        |  reverse |
    |        |        |  lookup  |
    |        |<-----national ID-|
    |        |       |          |
    |--investigation-|          |
\end{verbatim}

\section{Private Sector Applications}

\subsection{Multi-Account Prevention}

Services that may require AHI:
\begin{itemize}
  \item Social networks
  \item Ticket sales platforms
  \item Online gaming
  \item Marketplace fraud prevention
\end{itemize}

Account registration flow:
\begin{enumerate}
  \item Service generates and publishes service-specific identifier
  \item Service notifies citizens: "AHI required for registration"
  \item Citizen computes AHI from service ID and national ID
  \item Service verifies AHI validity via ZKP
  \item Service checks AHI uniqueness in database:
    \begin{itemize}
      \item Duplicate found $\Rightarrow$ Reject (multi-account prevention)
      \item No duplicate $\Rightarrow$ Accept and record AHI
    \end{itemize}
\end{enumerate}

Account ban enforcement:
\begin{itemize}
  \item Service terminates account for policy violation
  \item Service blacklists corresponding AHI
  \item If same person attempts re-registration: Same national ID $\Rightarrow$ Same AHI
  \item Service queries blacklist $\Rightarrow$ Match found $\Rightarrow$ Registration denied
  \item Result: Re-registration is prevented
\end{itemize}

\section{Financial Institution Applications}

\subsection{Account Opening with AHI}

Preconditions:
\begin{itemize}
  \item Institution legally requires AHI (compliance mandate)
  \item Customer has national ID VC
\end{itemize}

Flow:
\begin{enumerate}
  \item Institution generates purpose-specific identifiers
  \item Institution notifies: "AHI required for compliance"
  \item Customer computes AHI
  \item Institution verifies AHI via ZKP
  \item Institution links AHI to customer information (not national ID)
  \item System enables cross-institutional AML tracking using AHI
\end{enumerate}

Benefits:
\begin{itemize}
  \item Money laundering prevention
  \item Traceability of high-value transactions
  \item Reduced national ID exposure risk
  \item Cross-bank transparency for regulatory compliance
\end{itemize}

\section{Security Requirements}

\subsection{Hash Function}

\begin{itemize}
  \item \textbf{Requirement}: Post-quantum cryptography resistant
  \item \textbf{Recommended}: SHA-3, BLAKE3
  \item \textbf{Properties}:
    \begin{itemize}
      \item One-way (preimage resistance)
      \item Collision resistance
      \item Second preimage resistance
    \end{itemize}
\end{itemize}

\subsection{Zero-Knowledge Proof}

\begin{itemize}
  \item \textbf{Requirement}: PQC-resistant ZKP scheme
  \item \textbf{Proof contents}:
    \begin{itemize}
      \item Household VC validity
      \item National ID possession
      \item Hash computation correctness
    \end{itemize}
  \item \textbf{UX consideration}: Pre-computation for minimal response time
\end{itemize}

\subsection{Household VC Management}

\begin{itemize}
  \item Encrypted storage in wallet
  \item National ID tampering prevention
  \item VC issuer signature verification
\end{itemize}

\subsection{Municipality National ID Management}

\begin{itemize}
  \item Warrant legitimacy verification
  \item Access logging for all reverse lookups
  \item Unauthorized access prevention
  \item Database encryption
  \item Multi-factor authentication for staff
\end{itemize}

\subsection{Audit Section ID Management}

\begin{itemize}
  \item ID uniqueness guarantee
  \item Public registry verifiability
  \item ID misuse prevention (rate limiting)
\end{itemize}

\section{Privacy Protections}

\subsection{Anti-Linkage Across Services}

\begin{table}[h]
\centering
\begin{tabular}{|l|l|}
\hline
\textbf{Scenario} & \textbf{Prevention Mechanism} \\
\hline
Different government services & Different audit section IDs $\Rightarrow$ Different hashes \\
Same service, multiple users & Same AHI per person, not linkable across services \\
Different private services & Different service IDs $\Rightarrow$ Different hashes \\
\hline
\end{tabular}
\end{table}

\subsection{National ID Non-Disclosure}

\begin{itemize}
  \item Citizens never directly present national ID
  \item Service providers cannot learn national ID
  \item Only municipalities and investigating agencies handle national IDs
\end{itemize}

\subsection{Evasion Prevention}

\begin{itemize}
  \item Even if citizen discards secret keys, audit is still possible
  \item AHI is deterministically derived from national ID
  \item Municipality can always reverse-lookup the AHI
  \item Intentional evasion is technically impossible
\end{itemize}

\section{Legal and Regulatory Requirements}

\subsection{Warrant Issuance Standards}

\begin{itemize}
  \item Reasonable suspicion of fraud
  \item Investigative necessity and proportionality
  \item Privacy violation minimization
\end{itemize}

\subsection{Disclosure Procedure Transparency}

\begin{itemize}
  \item Warrant issuance records
  \item Municipality disclosure execution logs
  \item Post-disclosure citizen notification (where legally permitted)
\end{itemize}

\subsection{Social Consensus Formation}

\begin{itemize}
  \item Clear definition of audit-required services
  \item Appropriate audit section design and granularity
  \item Legal interpretation of national ID hash usage
\end{itemize}

\section{Implementation Guidelines}

\subsection{Wallet Implementation}

\subsubsection{Required Functions}

\begin{verbatim}
class AuditWallet where
  -- Household VC storage
  storeHouseholdVC : HouseholdVC → IO Unit

  -- AHI generation
  generateHashId : AuditCategoryId → IO ByteArray

  -- ZKP generation
  generateZKP : AuditCategoryId → IO AnonymousHashZKP

  -- Secure national ID storage (encrypted)
  secureStore : EncryptedData → IO Unit
\end{verbatim}

\subsubsection{Security Requirements}

\begin{itemize}
  \item \textbf{National ID encryption}: Use device secure storage (Keychain, TEE)
  \item \textbf{Hash generation UX}: One-click generation
  \item \textbf{ZKP pre-computation}: Minimize response time via offline generation
  \item \textbf{Audit history}: Local logging of when and which audit section identifiers were used
\end{itemize}

\subsection{Service Provider Implementation}

\subsubsection{Database Schema}

\begin{verbatim}
CREATE TABLE anonymous_hash_identifiers (
  hash_id BYTEA PRIMARY KEY,
  audit_category_id VARCHAR(255) NOT NULL,
  first_seen_at TIMESTAMP NOT NULL,
  service_data JSONB,
  is_blacklisted BOOLEAN DEFAULT FALSE,
  INDEX idx_category (audit_category_id),
  INDEX idx_blacklist (is_blacklisted)
);
\end{verbatim}

\subsubsection{ZKP Verification}

\begin{verbatim}
def verifyServiceRequest
    (hashId : ByteArray)
    (zkp : AnonymousHashZKP)
    (categoryId : AuditCategoryId) : IO (Result ServiceToken) := do
  -- 1. ZKP verification
  if !verifyAnonymousHashZKP zkp then
    return .error "ZKP verification failed"

  -- 2. Audit section consistency
  if zkp.publicInputs.categoryId ≠ categoryId then
    return .error "Category mismatch"

  -- 3. Duplicate check
  if ← isDuplicate hashId then
    return .error "Duplicate registration"

  -- 4. Blacklist check
  if ← isBlacklisted hashId then
    return .error "Blacklisted hash"

  -- 5. Issue service token
  issueServiceToken hashId
\end{verbatim}

\subsubsection{Performance Optimization}

\begin{itemize}
  \item Parallel ZKP verification
  \item Short-term ZKP verification caching
  \item Index optimization on \texttt{hash\_id}, \texttt{audit\_category\_id}, \texttt{is\_blacklisted}
\end{itemize}

\subsection{Municipality Implementation}

\subsubsection{Reverse Lookup}

\begin{verbatim}
def reverseLookup
    (hashId : ByteArray)
    (categoryId : AuditCategoryId)
    (warrant : Warrant) : IO (Option String) := do
  -- 1. Warrant validity verification
  if !verifyWarrant warrant then
    return none

  -- 2. Access logging
  logAccess warrant hashId categoryId

  -- 3. Reverse lookup in national ID database
  for myNumber in ← getAllMyNumbers do
    let computed := generateAnonymousHashId categoryId myNumber
    if computed = hashId then
      -- 4. Disclosure logging
      logDisclosure myNumber hashId warrant
      return some myNumber

  return none
\end{verbatim}

\subsubsection{Security Requirements}

\begin{itemize}
  \item Warrant management system integration with real-time verification
  \item Complete access logging for all reverse lookups
  \item National ID database encryption at rest
  \item Multi-factor authentication and role-based access control
\end{itemize}

\section{Formal Verification}

\subsection{Theorem: Anti-Linkability Across Audit Domains}

\begin{verbatim}
theorem different_categories_prevent_linkability
    (myNumber : String)
    (cat1 cat2 : AuditCategoryId)
    (h : cat1.id ≠ cat2.id) :
  generateAnonymousHashId cat1 myNumber ≠
  generateAnonymousHashId cat2 myNumber := by
  -- By hash function collision resistance,
  -- different inputs produce different outputs
  apply Hash.collision_resistance
  simp [generateAnonymousHashId]
  exact String.append_ne_of_prefix_ne h
\end{verbatim}

\textbf{Result}: Linking AHIs across services is computationally infeasible.

\subsection{Theorem: Evasion Prevention}

\begin{verbatim}
theorem audit_always_possible
    (citizen : Citizen)
    (myNumber : String)
    (cat : AuditCategoryId)
    (h1 : citizen.householdVC.credentialSubject.myNumber = myNumber) :
  ∃ (hashId : ByteArray),
    hashId = generateAnonymousHashId cat myNumber ∧
    canReverseLookup hashId myNumber cat := by
  -- As long as municipality maintains national ID database,
  -- reverse lookup is always possible
  exists generateAnonymousHashId cat myNumber
  constructor
  · rfl
  · apply municipality_has_database
    exact h1
\end{verbatim}

\textbf{Result}: Audit is always possible via legal procedure.

\subsection{Theorem: Privacy Preservation}

\begin{verbatim}
theorem zkp_preserves_privacy
    (zkp : AnonymousHashZKP)
    (adversary : Adversary) :
  computationallyInfeasible
    (adversary.extractMyNumber zkp) := by
  -- By ZKP soundness property,
  -- secret inputs cannot be extracted from proof
  apply ZKP.knowledge_soundness
  apply ZKP.zero_knowledge_property
\end{verbatim}

\textbf{Result}: Service providers and third parties cannot learn national IDs.

\subsection{Cryptographic Security Summary}

\begin{table}[h]
\centering
\begin{tabular}{|l|l|l|}
\hline
\textbf{Property} & \textbf{Cryptographic Basis} & \textbf{Security Level} \\
\hline
Anti-linkability & Hash collision resistance & Computational (128-bit) \\
Evasion prevention & One-way function property & Information-theoretic \\
Privacy protection & ZKP knowledge soundness & Computational (128-bit) \\
Hash correctness & ZKP completeness & Mathematical proof \\
\hline
\end{tabular}
\end{table}

\section{Future Research Directions}

\subsection{Technical Challenges}

\begin{itemize}
  \item PQC ZKP optimization (proof generation time and size)
  \item UX improvement for hash and ZKP generation
  \item Scalability for large-scale reverse lookups
\end{itemize}

\subsection{Institutional Challenges}

\begin{itemize}
  \item Clear definition of audit-required services
  \item Legal framework for national ID hash usage
  \item Appropriate audit section granularity design
\end{itemize}

\subsection{Standardization}

\begin{itemize}
  \item AMATELUS protocol detailed specifications
  \item Interoperability with other SSI systems
  \item International standardization (W3C, ISO)
\end{itemize}

\section*{Key Design Principles (Audit Mechanism)}

\begin{enumerate}
  \item \textbf{Optionality}: AHI is used only when required by service
  \item \textbf{Privacy by default}: Services not requiring AHI provide complete privacy
  \item \textbf{Service-specific identifiers}: Each service gets different hash, preventing profiling
  \item \textbf{Legal alignment}: Audit is possible only via court warrants and legal procedure
  \item \textbf{Transparency}: All reverse lookups are logged and auditable
  \item \textbf{Citizen control}: Citizens retain cryptographic control over their identities
  \item \textbf{Non-repudiation}: Service providers cannot deny or forge audit records
\end{enumerate}
